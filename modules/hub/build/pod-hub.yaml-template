apiVersion: v1
kind: Pod
metadata:
  name: hub
  namespace: ##NS##
  labels:
    name: lbl-##MODULE_NAME##
spec:
  initContainers:
  - name: init-gitclone
    image: ajeetraina/alpine-git
    command: ['sh', '-c', "git clone -b kubernetes https://github.com/kooplex/kooplex-hub.git /x || true"]
    volumeMounts:
      - mountPath: /x
        name: svc
        subPath: code
  containers:
  - image: ##MY_REGISTRY##/##PREFIX##-hub
#    command: [ 'sleep', 'infinity' ]
    name: hub
    ports:
      - containerPort: 80
        name: http
    volumeMounts:
      - mountPath: /root/.kube
        name: kubeconf
      - mountPath: /kooplexhub
        name: svc
        subPath: code
      - mountPath: /var/log/hub
        name: svc
        subPath: log
      - mountPath: /mnt/home
        name: userdata
        subPath: home
      - mountPath: /mnt/garbage
        name: userdata
        subPath: garbage
      - mountPath: /mnt/projects
        name: userdata
        subPath: projects
      - mountPath: /mnt/reports
        name: userdata
        subPath: reports
      - mountPath: /mnt/report_prepare
        name: userdata
        subPath: report_prepare
      - mountPath: /mnt/course
        name: userdata
        subPath: edu/course
      - mountPath: /mnt/course_assignment
        name: userdata
        subPath: edu/course_assignment
      - mountPath: /mnt/course_workdir
        name: userdata
        subPath: edu/course_workdir
      - mountPath: /etc/mnt
        name: nslcd
        readOnly: true
#      - mountPath: /etc/secrets
#        name: svcconf
#        subPath: ##MODULE_NAME##/secrets
    env:
      - name: HUBDBROOT_PW
        value: "##HUB_MYSQL_ROOTPW##"
      - name: HUBDB_HOSTNAME
        value: "##MODULE_NAME##-mysql"
      - name: LANG
        value: "en_US.UTF-8"
      - name: DJANGO_SECRET_KEY
        value: "##DJANGO_SECRET_KEY##"
      - name: PREFIX
        value: "##PREFIX##"
      - name: DOMAIN
        value: "##FQDN##"
      - name: HUBDB
        value: hub
      - name: HUBDB_USER
        value: "##HUBDB_USER##"
      - name: HUBDB_PW
        value: "##HUBDB_PW##"
      - name: HUBLDAP_PW
        value: "##LDAP_ADMIN_PASSWORD##"
  nodeSelector:
    kubernetes.io/hostname: ##SERVICENODE##
  volumes:
    - name: kubeconf
      configMap:
        name: kubeconfig
        items:
        - key: "kubeconf"
          path: "config"
    - name: svc
      persistentVolumeClaim:
        claimName: ##PV_SERVICE##
    - name: userdata
      persistentVolumeClaim:
        claimName: ##PV_USERDATA##
    - name: nslcd
      configMap:
        name: nslcd
        items:
        - key: "nslcd"
          path: "nslcd.conf"
---
apiVersion: v1
kind: Pod
metadata:
  name: ##MODULE_NAME##-mysql
  namespace: ##NS##
  labels:
    name: lbl-##MODULE_NAME##-mysql
spec:
  containers:
  - image: mariadb:10.5.4
    name: ##MODULE_NAME##-mysql
    ports:
      - containerPort: 3306
        name: mysql
    volumeMounts:
      - mountPath: /var/lib/mysql
        name: svc
        subPath: mysql
#      - /etc/localtime:/etc/localtime:ro
    env:
      - name: MYSQL_ROOT_PASSWORD
        value: "##HUB_MYSQL_ROOTPW##"
      - name: MYSQL_USER
        value: "##HUBDB_USER##"
      - name: MYSQL_PASSWORD
        value: "##HUBDB_PW##"
      - name: MYSQL_DATABASE
        value: "hub"
      - name: MYSQL_LOG_CONSOLE
        value: "true"
  nodeSelector:
    kubernetes.io/hostname: ##SERVICENODE##
  volumes:
    - name: svc
      persistentVolumeClaim:
        claimName: ##PV_SERVICE##
